<!DOCTYPE html>
<html lang="te">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vinayaka DJ Player - Digital DreamsTechnologies</title>
    <!-- Font Awesome Icons Kosam -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        /* Basic Resets & Global Styles */
        :root {
            --bg-color: #121212;
            --surface-color: #181818;
            --primary-element-color: #282828;
            --mixer-color: #202020;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --accent-color: #1DB954; /* Spotify green */
            --deck-a-color: #4d8cff; /* Blue */
            --deck-b-color: #4dff8c; /* Green */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* Standard syntax */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Main App Container */
        .dj-app {
            width: 100%;
            height: 100%;
            max-width: 480px; /* Mobile-first max width */
            background-color: var(--surface-color);
            box-shadow: 0 0 30px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Header Section */
        .app-header {
            padding: 12px 15px;
            text-align: center;
            background-color: #000; /* Darker header */
            border-bottom: 1px solid #333;
            flex-shrink: 0;
            position: relative;
        }

        .app-header h1 {
            font-size: 1em;
            font-weight: 500;
            color: var(--text-secondary);
            letter-spacing: 1px;
        }

        /* Main controls (Decks + Mixer) wrapper */
        .main-console {
            flex-shrink: 0; /* Prevents this area from shrinking */
            transition: all 0.3s ease-in-out;
        }

        /* Decks Section Wrapper */
        .deck-wrapper {
            padding: 5px 15px;
            background-color: var(--primary-element-color);
            margin: 8px 0 10px;
            border-bottom: 1px solid #2a2a2a;
        }
        
        .deck {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 10px;
            border: 2px solid transparent; /* Base border */
            transition: border-color 0.2s ease-in-out; /* Smooth transition for border color */
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .deck-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .deck-label {
            font-size: 0.8em;
            color: var(--text-secondary);
            font-weight: bold;
        }
        .deck-label.deck-a { color: var(--deck-a-color); }
        .deck-label.deck-b { color: var(--deck-b-color); }
        
        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .volume-control i {
            font-size: 0.9em;
            color: var(--text-secondary);
        }
        .deck-volume-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 70px;
            height: 4px;
            background: #444;
            border-radius: 5px;
            outline: none;
        }
        .deck-volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 14px; height: 14px;
            background: var(--text-secondary);
            cursor: pointer; border-radius: 50%;
        }

        /* Song Title Marquee Effect */
        .song-title-wrapper { width: 100%; overflow: hidden; white-space: nowrap; text-align: center; }
        .song-display .song-title { display: inline-block; font-size: 0.9em; min-height: 1.2em; vertical-align: middle; }
        .song-title.scrolling-text { animation: marquee 10s linear infinite; padding-left: 100%; }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }
        .song-display .song-artist { font-size: 0.7em; color: var(--text-secondary); text-align: center; }
        .seek-bar-container { display: flex; align-items: center; gap: 10px; font-size: 0.7em; color: var(--text-secondary); }
        .seek-bar { -webkit-appearance: none; appearance: none; width: 100%; flex-grow: 1; height: 5px; background: #444; border-radius: 5px; outline: none; }
        .seek-bar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 15px; height: 15px; background: var(--accent-color); cursor: pointer; border-radius: 50%; }
        .deck-controls { display: flex; justify-content: center; align-items: center; gap: 15px; }
        .deck-control-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background-color: #333; color: #fff; font-size: 1em; cursor: pointer; transition: transform 0.1s, background-color 0.2s; }
        .deck-control-btn:active { transform: scale(0.95); }
        .play-pause-deck-btn.playing { background-color: var(--accent-color); }

        /* Mixer Section */
        .mixer {
            padding: 10px 15px;
            background-color: var(--mixer-color);
            border-block: 1px solid #333;
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
            margin: 10px 0 12px;
            border-top: 2px solid #2a2a2a;
            border-bottom: 2px solid #2a2a2a;
            box-shadow: inset 0 1px 0 rgba(0,0,0,0.4), inset 0 -1px 0 rgba(0,0,0,0.4);
        }
        
        .mixer-channels {
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
        }
        .mixer-channel {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            width: 45%;
        }
        .knob-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .knob-label {
            font-size: 0.6em;
            color: var(--text-secondary);
            font-weight: bold;
            margin-bottom: 4px;
        }
        .knob {
            -webkit-appearance: none; appearance: none;
            width: 45px; height: 45px;
            border-radius: 50%; background: #444; border: 2px solid #333;
            cursor: ns-resize; /* Vertical drag cursor */
            position: relative;
            touch-action: none; /* Prevent page scroll/zoom while dragging on mobile */
        }
        .knob::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 0; height: 0; }
        .knob::before {
            content: ''; position: absolute;
            width: 3px; height: 10px; background-color: var(--text-primary);
            top: 4px; left: 50%;
            transform: translateX(-50%); border-radius: 2px;
            pointer-events: none;
        }
        
        .crossfader { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #444; border-radius: 5px; outline: none; }
        .crossfader::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 22px; height: 22px; background: var(--accent-color); cursor: pointer; border-radius: 50%; }

        /* Playlist Section */
        .playlist-container { 
            flex-grow: 1; min-height: 100px;
            padding: 10px; display: flex; flex-direction: column; 
            overflow-y: auto; 
        }
        .playlist-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-shrink: 0; }
        .playlist-actions button { background: #333; border: none; color: #fff; padding: 8px 12px; border-radius: 20px; cursor: pointer; margin-left: 5px; font-size: 0.9em; transition: background-color 0.2s; }
        #auto-dj-btn.active, #reorder-btn.active, #server-songs-btn.active { background-color: var(--accent-color); }
        #upload-input { display: none; }
        .playlist { list-style: none; overflow-y: auto; flex-grow: 1; }
        .playlist li { border-bottom: 1px solid #282828; transition: background-color 0.2s; }
        .playlist li:hover { background-color: #2a2a2a; }
        .playlist li.deck-a-loaded { background-color: rgba(77, 140, 255, 0.15); border-left: 4px solid var(--deck-a-color); }
        .playlist li.deck-b-loaded { background-color: rgba(77, 255, 140, 0.15); border-left: 4px solid var(--deck-b-color); }
        .song-item { display: flex; align-items: center; padding: 12px 5px; }
        .now-playing-indicator { width: 20px; font-size: 1em; color: var(--accent-color); opacity: 0; transition: opacity 0.3s; }
        .now-playing .now-playing-indicator { opacity: 1; }
        .song-info { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .more-options-btn { background: none; border: none; color: var(--text-secondary); font-size: 1.2em; cursor: pointer; padding: 5px 10px; }
        
        /* Reorder Styles */
        .reorder-handle { display: none; color: var(--text-secondary); cursor: grab; padding: 5px 10px; }
        .playlist.reorder-mode li .reorder-handle { display: block; }
        .playlist.reorder-mode li .more-options-btn { display: none; }
        .playlist li.dragging { opacity: 0.4; }
        .playlist li.drag-over { border-top: 2px solid var(--accent-color); }

        /* Server-available indicator */
        .server-available-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #22c55e; /* green-500 */
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
        }

        /* Mixer action button (lock) */
        .mixer-action {
            background: #222;
            color: var(--text-secondary);
            border: 1px solid #333;
            border-radius: 18px;
            padding: 6px 10px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }
        .mixer-action.active { color: #1DB954; border-color: #1DB954; }
        .mixer-action i { font-size: 0.95em; }
        .mixer-action span { font-size: 0.8em; }
        
 
        /* Fullscreen Playlist Styles */
        .dj-app.playlist-fullscreen-active .main-console {
            display: none;
        }
        .dj-app.playlist-fullscreen-active .playlist-container {
            padding: 20px;
        }

        /* Context Menu Styling */
        #song-options-menu {
            position: fixed; display: none;
            background-color: #333;
            border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            z-index: 1000; overflow: hidden;
        }
        #song-options-menu button {
            display: block; width: 100%; padding: 12px 20px;
            background: none; border: none; color: white; text-align: left;
            cursor: pointer; font-size: 1em;
        }
        #song-options-menu button:hover { background-color: #444; }

        /* Custom Confirmation Dialog */
        .confirmation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .confirmation-dialog {
            background-color: var(--surface-color);
            border-radius: 12px;
            padding: 25px;
            max-width: 350px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            border: 1px solid #333;
            text-align: center;
        }

        .confirmation-dialog h3 {
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .confirmation-dialog p {
            color: var(--text-secondary);
            margin-bottom: 25px;
            line-height: 1.4;
            font-size: 0.95em;
        }

        .confirmation-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .confirmation-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s ease;
            min-width: 80px;
        }

        .confirmation-btn.cancel {
            background-color: #444;
            color: var(--text-primary);
        }

        .confirmation-btn.cancel:hover {
            background-color: #555;
        }

        .confirmation-btn.confirm {
            background-color: #ff4757;
            color: white;
        }

        .confirmation-btn.confirm:hover {
            background-color: #ff3742;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>

    <div class="dj-app">
        <header class="app-header">
            <h1>Digital Dreams Technologies</h1>
        </header>
        <div class="main-console">
            <!-- ===== DECK A SECTION ===== -->
            <section class="deck-wrapper">
                <div class="deck" id="deck-a-ui">
                    <div class="deck-header">
                        <div class="deck-label deck-a">DECK A</div>
                        <div class="volume-control">
                            <i class="fas fa-volume-low"></i>
                            <input type="range" min="0" max="100" value="100" class="deck-volume-slider" id="deck-a-volume">
                        </div>
                    </div>
                    <div class="song-display">
                        <div class="song-title-wrapper"><h4 class="song-title">Load a Song</h4></div>
                        <p class="song-artist">--</p>
                    </div>
                    <div class="seek-bar-container">
                        <span class="current-time">0:00</span>
                        <input type="range" min="0" max="100" value="0" class="seek-bar" id="deck-a-seek">
                        <span class="duration">0:00</span>
                    </div>
                    <div class="deck-controls">
                        <button class="deck-control-btn" id="cue-a-btn" title="Cue Deck A"><i class="fas fa-undo-alt"></i></button>
                        <button class="deck-control-btn play-pause-deck-btn" id="play-pause-a-btn" title="Play/Pause Deck A"><i class="fas fa-play"></i></button>
                        <button class="deck-control-btn" id="stop-a-btn" title="Stop Deck A"><i class="fas fa-stop"></i></button>
                    </div>
                </div>
            </section>

            <!-- ===== MIXER SECTION ===== -->
            <section class="mixer">
                <div class="playlist-header" style="margin: 0;">
                    <div></div>
                    <button id="mixer-lock-btn" class="mixer-action" title="Lock mixer knobs">
                        <i class="fas fa-lock-open"></i>
                        <span>Unlocked</span>
                    </button>
                </div>
                <div class="mixer-channels">
                    <div class="mixer-channel">
                        <div class="knob-container"><label class="knob-label">HIGH</label><input type="range" min="-100" max="100" value="0" class="knob eq-knob" id="high-a"></div>
                        <div class="knob-container"><label class="knob-label">MID</label><input type="range" min="-100" max="100" value="0" class="knob eq-knob" id="mid-a"></div>
                        <div class="knob-container"><label class="knob-label">LOW</label><input type="range" min="-100" max="100" value="0" class="knob eq-knob" id="low-a"></div>
                        <div class="knob-container"><label class="knob-label">FILTER</label><input type="range" min="-100" max="100" value="0" class="knob filter-knob" id="filter-a"></div>
                    </div>
                    <div class="mixer-channel">
                        <div class="knob-container"><label class="knob-label">HIGH</label><input type="range" min="-100" max="100" value="0" class="knob eq-knob" id="high-b"></div>
                        <div class="knob-container"><label class="knob-label">MID</label><input type="range" min="-100" max="100" value="0" class="knob eq-knob" id="mid-b"></div>
                        <div class="knob-container"><label class="knob-label">LOW</label><input type="range" min="-100" max="100" value="0" class="knob eq-knob" id="low-b"></div>
                        <div class="knob-container"><label class="knob-label">FILTER</label><input type="range" min="-100" max="100" value="0" class="knob filter-knob" id="filter-b"></div>
                    </div>
                </div>
                <input type="range" min="-100" max="100" value="0" class="crossfader" id="crossfader">
            </section>

            <!-- ===== DECK B SECTION ===== -->
            <section class="deck-wrapper">
                 <div class="deck" id="deck-b-ui">
                    <div class="deck-header">
                        <div class="deck-label deck-b">DECK B</div>
                         <div class="volume-control">
                            <i class="fas fa-volume-low"></i>
                            <input type="range" min="0" max="100" value="100" class="deck-volume-slider" id="deck-b-volume">
                        </div>
                    </div>
                     <div class="song-display">
                         <div class="song-title-wrapper"><h4 class="song-title">Load a Song</h4></div>
                        <p class="song-artist">--</p>
                    </div>
                     <div class="seek-bar-container">
                        <span class="current-time">0:00</span>
                        <input type="range" min="0" max="100" value="0" class="seek-bar" id="deck-b-seek">
                        <span class="duration">0:00</span>
                    </div>
                    <div class="deck-controls">
                        <button class="deck-control-btn" id="cue-b-btn" title="Cue Deck B"><i class="fas fa-undo-alt"></i></button>
                        <button class="deck-control-btn play-pause-deck-btn" id="play-pause-b-btn" title="Play/Pause Deck B"><i class="fas fa-play"></i></button>
                        <button class="deck-control-btn" id="stop-b-btn" title="Stop Deck B"><i class="fas fa-stop"></i></button>
                    </div>
                </div>
            </section>
        </div>

        <!-- ===== PLAYLIST SECTION ===== -->
        <section class="playlist-container">
            <div class="playlist-header">
                <h3>Queue</h3>
                <div class="playlist-actions">
                    <button id="upload-btn" title="Add Songs"><i class="fas fa-plus"></i></button>
                    <button id="server-songs-btn" title="Load Server Songs"><i class="fas fa-cloud-arrow-down"></i></button>
                    <button id="reorder-btn" title="Reorder Playlist"><i class="fas fa-bars-staggered"></i></button>
                    <button id="auto-dj-btn" title="Auto-DJ"><i class="fas fa-robot"></i></button>
                    <button id="fullscreen-playlist-btn" title="Fullscreen Playlist"><i class="fas fa-expand"></i></button>
                    <input type="file" id="upload-input" accept="audio/*" multiple>
                </div>
            </div>
            <ul class="playlist" id="playlist-ul"></ul>
        </section>
    </div>

    <!-- Context Menu for Songs -->
    <div id="song-options-menu">
        <button id="load-to-deck-a">Load to Deck A</button>
        <button id="load-to-deck-b">Load to Deck B</button>
        <button id="remove-from-list" style="color: #ff6b6b;">Remove</button>
    </div>

    <!-- Custom Confirmation Dialog -->
    <div id="confirmation-dialog" class="confirmation-overlay">
        <div class="confirmation-dialog">
            <h3>Confirmation</h3>
            <p id="confirmation-message"></p>
            <div class="confirmation-buttons">
                <button class="confirmation-btn cancel" id="confirmation-cancel">Cancel</button>
                <button class="confirmation-btn confirm" id="confirmation-confirm">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const djApp = document.querySelector('.dj-app');
            const playlistUl = document.getElementById('playlist-ul');
            const uploadBtn = document.getElementById('upload-btn');
            const uploadInput = document.getElementById('upload-input');
            const contextMenu = document.getElementById('song-options-menu');
            const crossfader = document.getElementById('crossfader');
            const autoDjBtn = document.getElementById('auto-dj-btn');
            const fullscreenPlaylistBtn = document.getElementById('fullscreen-playlist-btn');
            const reorderBtn = document.getElementById('reorder-btn');
            const serverSongsBtn = document.getElementById('server-songs-btn');
            const mixerLockBtn = document.getElementById('mixer-lock-btn');
            const confirmationDialog = document.getElementById('confirmation-dialog');
            const confirmationMessage = document.getElementById('confirmation-message');
            const confirmationCancelBtn = document.getElementById('confirmation-cancel');
            const confirmationConfirmBtn = document.getElementById('confirmation-confirm');

            const deckAUi = {
                container: document.getElementById('deck-a-ui'),
                title: document.querySelector('#deck-a-ui .song-title'),
                artist: document.querySelector('#deck-a-ui .song-artist'),
                currentTime: document.querySelector('#deck-a-ui .current-time'),
                duration: document.querySelector('#deck-a-ui .duration'),
                playPauseBtn: document.getElementById('play-pause-a-btn'),
                cueBtn: document.getElementById('cue-a-btn'),
                stopBtn: document.getElementById('stop-a-btn'),
                seekBar: document.getElementById('deck-a-seek'),
                volumeSlider: document.getElementById('deck-a-volume'),
                eq: { high: document.getElementById('high-a'), mid: document.getElementById('mid-a'), low: document.getElementById('low-a'), filter: document.getElementById('filter-a') }
            };
            const deckBUi = {
                container: document.getElementById('deck-b-ui'),
                title: document.querySelector('#deck-b-ui .song-title'),
                artist: document.querySelector('#deck-b-ui .song-artist'),
                currentTime: document.querySelector('#deck-b-ui .current-time'),
                duration: document.querySelector('#deck-b-ui .duration'),
                playPauseBtn: document.getElementById('play-pause-b-btn'),
                cueBtn: document.getElementById('cue-b-btn'),
                stopBtn: document.getElementById('stop-b-btn'),
                seekBar: document.getElementById('deck-b-seek'),
                volumeSlider: document.getElementById('deck-b-volume'),
                eq: { high: document.getElementById('high-b'), mid: document.getElementById('mid-b'), low: document.getElementById('low-b'), filter: document.getElementById('filter-b') }
            };
            
            // --- SMOOTH KNOB CONTROL LOGIC ---
            const knobs = document.querySelectorAll('.knob');
            knobs.forEach(knob => {
                knob.addEventListener('input', () => {
                    if (isMixerLocked) return;
                    const value = knob.value;
                    const rotation = (value - knob.min) / (knob.max - knob.min) * 270 - 135;
                    knob.style.transform = `rotate(${rotation}deg)`;
                });
                knob.dispatchEvent(new Event('input'));

                knob.addEventListener('dblclick', () => {
                    if (isMixerLocked) return;
                    knob.value = 0;
                    knob.dispatchEvent(new Event('input'));
                });

                // Mobile double-tap reset support
                let lastTapTime = 0;
                knob.addEventListener('touchend', (e) => {
                    if (isMixerLocked) { e.preventDefault(); return; }
                    const now = Date.now();
                    if (now - lastTapTime < 300) {
                        e.preventDefault();
                        knob.value = 0;
                        knob.dispatchEvent(new Event('input'));
                        lastTapTime = 0;
                    } else {
                        lastTapTime = now;
                    }
                }, { passive: false });

                let isDragging = false;
                let startY = 0;
                let startValue = 0;

                const onDragStart = (e) => {
                    if (isMixerLocked) { e.preventDefault(); return; }
                    isDragging = true;
                    startY = e.clientY || e.touches[0].clientY;
                    startValue = parseFloat(knob.value);
                    document.body.style.cursor = 'ns-resize';
                    window.addEventListener('mousemove', onDragMove);
                    window.addEventListener('mouseup', onDragEnd);
                    window.addEventListener('touchmove', onDragMove, { passive: false });
                    window.addEventListener('touchend', onDragEnd);
                    e.preventDefault();
                };

                const onDragMove = (e) => {
                    if (!isDragging) return;
                    if (isMixerLocked) { e.preventDefault(); return; }
                    e.preventDefault();
                    const currentY = e.clientY || e.touches[0].clientY;
                    const deltaY = currentY - startY;
                    const sensitivity = 1; 
                    let newValue = startValue - (deltaY * sensitivity);
                    newValue = Math.max(parseFloat(knob.min), Math.min(parseFloat(knob.max), newValue));
                    if (knob.value !== newValue) {
                        knob.value = newValue;
                        knob.dispatchEvent(new Event('input'));
                    }
                };

                const onDragEnd = () => {
                    isDragging = false;
                    document.body.style.cursor = 'default';
                    window.removeEventListener('mousemove', onDragMove);
                    window.removeEventListener('mouseup', onDragEnd);
                    window.removeEventListener('touchmove', onDragMove);
                    window.removeEventListener('touchend', onDragEnd);
                };

                knob.addEventListener('mousedown', onDragStart);
                knob.addEventListener('touchstart', onDragStart, { passive: false });
            });

            // Mixer lock toggle
            let isMixerLocked = true;
            function updateMixerLockUI() {
                const icon = mixerLockBtn.querySelector('i');
                const label = mixerLockBtn.querySelector('span');
                mixerLockBtn.classList.toggle('active', isMixerLocked);
                if (isMixerLocked) {
                    icon.classList.remove('fa-lock-open');
                    icon.classList.add('fa-lock');
                    label.textContent = 'Locked';
                    mixerLockBtn.title = 'Unlock mixer knobs';
                } else {
                    icon.classList.remove('fa-lock');
                    icon.classList.add('fa-lock-open');
                    label.textContent = 'Unlocked';
                    mixerLockBtn.title = 'Lock mixer knobs';
                }
            }
            mixerLockBtn.addEventListener('click', () => {
                isMixerLocked = !isMixerLocked;
                updateMixerLockUI();
            });
            updateMixerLockUI();


            // --- State ---
            let playlist = [];
            let nextSongId = 0;
            let activeContextMenuSongId = null;
            let isSeeking = { a: false, b: false };
            let isAutoDjEnabled = false;
            let isReorderMode = false;
            let areServerSongsLoaded = false;
            const cachedServerUrls = new Set();
            
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const deckA = createDeckState(deckAUi, 'a');
            const deckB = createDeckState(deckBUi, 'b');

            // --- Server Songs List ---
            // Ekkada, 'djsongs' folder lo unna mee paatala perlu ivvandi.
            const serverSongList = [
                { title: "00GanaGana Gantalu mogenura", artist: "Local Mix", url: "djsongs/00GanaGana Gantalu mogenura.mp3", type: 'server' },
                { title: "Naaroyalenfieldraja001", artist: "Local Mix", url: "djsongs/Naaroyalenfieldraja001.mp3", type: 'server' },
                { title: "Naaroyalenfieldraja002", artist: "Local Mix", url: "djsongs/Naaroyalenfieldraja002.mp3", type: 'server' },
                { title: "Naaroyalenfieldraja003", artist: "Local Mix", url: "djsongs/Naaroyalenfieldraja003.mp3", type: 'server' },
                { title: "NeeBulletSoundVinabadagane - 001", artist: "Local Mix", url: "djsongs/NeeBulletSoundVinabadagane - 001.mp3", type: 'server' },
                { title: "NeeBulletSoundVinabadagane - 002", artist: "Local Mix", url: "djsongs/NeeBulletSoundVinabadagane - 002.mp3", type: 'server' },
                { title: "NeeBulletSoundVinabadagane - 003", artist: "Local Mix", url: "djsongs/NeeBulletSoundVinabadagane - 003.mp3", type: 'server' },
                { title: "NenuAganiSelayeruroy-001", artist: "Local Mix", url: "djsongs/NenuAganiSelayeruroy-001.mp3", type: 'server' },
                { title: "NenuAganiSelayeruroy-002", artist: "Local Mix", url: "djsongs/NenuAganiSelayeruroy-002.mp3", type: 'server' },
                { title: "NenuAganiSelayeruroy-003", artist: "Local Mix", url: "djsongs/NenuAganiSelayeruroy-003.mp3", type: 'server' },
                { title: "NenuAganiSelayeruroy-004", artist: "Local Mix", url: "djsongs/NenuAganiSelayeruroy-004.mp3", type: 'server' },
                { title: "kurralloy - 01", artist: "Local Mix", url: "djsongs/kurralloy - 01.mp3", type: 'server' },
                { title: "kurralloy - 02", artist: "Local Mix", url: "djsongs/kurralloy - 02.mp3", type: 'server' },
                { title: "Bgm-Raceboys-1", artist: "Local Mix", url: "djsongs/Bgm-Raceboys-1.mp3", type: 'server' },
                { title: "Bgm-Raceboys-2", artist: "Local Mix", url: "djsongs/Bgm-Raceboys-2.mp3", type: 'server' },
                { title: "Bgm-Raceboys-3", artist: "Local Mix", url: "djsongs/Bgm-Raceboys-3.mp3", type: 'server' },
                { title: "DJBgmDance-001", artist: "Local Mix", url: "djsongs/DJBgmDance-001.mp3", type: 'server' },
                { title: "DJBgmDance-002", artist: "Local Mix", url: "djsongs/DJBgmDance-002.mp3", type: 'server' },
                { title: "DJBgmDance-003", artist: "Local Mix", url: "djsongs/DJBgmDance-003.mp3", type: 'server' },
                { title: "DJBgmDance-004", artist: "Local Mix", url: "djsongs/DJBgmDance-004.mp3", type: 'server' },
                { title: "DJBgmDance-005", artist: "Local Mix", url: "djsongs/DJBgmDance-005.mp3", type: 'server' },
                { title: "DJBgmDance-006", artist: "Local Mix", url: "djsongs/DJBgmDance-006.mp3", type: 'server' },
                { title: "DJBgmDance-007", artist: "Local Mix", url: "djsongs/DJBgmDance-007.mp3", type: 'server' }
            ];

            // --- Functions ---
            function createDeckState(ui, deckId) {
                const audio = new Audio();
                const source = audioContext.createMediaElementSource(audio);
                const volumeGain = audioContext.createGain();
                const eqLow = audioContext.createBiquadFilter(); eqLow.type = 'lowshelf'; eqLow.frequency.value = 320;
                const eqMid = audioContext.createBiquadFilter(); eqMid.type = 'peaking'; eqMid.frequency.value = 1000; eqMid.Q.value = 0.5;
                const eqHigh = audioContext.createBiquadFilter(); eqHigh.type = 'highshelf'; eqHigh.frequency.value = 3200;
                const filter = audioContext.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = audioContext.sampleRate / 2;
                const crossfadeGain = audioContext.createGain();
                
                source.connect(volumeGain).connect(eqLow).connect(eqMid).connect(eqHigh).connect(filter).connect(crossfadeGain).connect(audioContext.destination);
                
                const deckState = { id: deckId, song: null, audio, isPlaying: false, ui, nodes: { volumeGain, eqLow, eqMid, eqHigh, filter, crossfadeGain } };
                audio.addEventListener('timeupdate', () => updateDeckTime(deckState));
                audio.addEventListener('loadedmetadata', () => updateDeckTime(deckState));
                audio.addEventListener('ended', () => handleSongEnd(deckState));
                return deckState;
            }

            function init() { 
                setupEventListeners(); 
                updateCrossfader();
                // Default enable Server Songs and Auto-DJ
                if (!areServerSongsLoaded) {
                    toggleServerSongs();
                }
                isAutoDjEnabled = true;
                autoDjBtn.classList.add('active');
            }

            function addSongToPlaylist(songData) { 
                const song = { id: nextSongId++, ...songData };
                playlist.push(song); 
                renderPlaylist(); 
            }

            function renderPlaylist() {
                playlistUl.innerHTML = '';
                playlist.forEach(song => {
                    const li = document.createElement('li');
                    li.dataset.songId = song.id;
                    li.draggable = isReorderMode;

                    const isDeckA = deckA.song && deckA.song.id === song.id;
                    const isDeckB = deckB.song && deckB.song.id === song.id;
                    if (isDeckA) li.classList.add('deck-a-loaded');
                    if (isDeckB) li.classList.add('deck-b-loaded');
                    if ((isDeckA && deckA.isPlaying) || (isDeckB && deckB.isPlaying)) li.classList.add('now-playing');
                    
                    const isCachedUrl = cachedServerUrls.has(song.url);
                    li.innerHTML = `
                        <div class="song-item">
                            <span class="reorder-handle"><i class="fas fa-grip-vertical"></i></span>
                            <span class="now-playing-indicator"><i class="fas fa-volume-high"></i></span>
                            ${isCachedUrl ? '<span class="server-available-dot" title="Cached from server"></span>' : ''}
                            <div class="song-info">
                                <span class="song-title">${song.title}</span>
                                <span class="song-artist">${song.artist}</span>
                            </div>
                            <button class="more-options-btn"><i class="fas fa-ellipsis-v"></i></button>
                        </div>`;
                    playlistUl.appendChild(li);
                });
            }
            
            function checkAndApplyMarquee(element) {
                const wrapper = element.parentElement;
                element.classList.remove('scrolling-text');
                setTimeout(() => { if (element.scrollWidth > wrapper.clientWidth) element.classList.add('scrolling-text'); }, 50);
            }

            function loadSongToDeck(deck, songId, shouldAutoplay = false) {
                let song = playlist.find(s => s.id === songId);
                if (!song || isReorderMode) return;
                if (audioContext.state === 'suspended') audioContext.resume();

                const wasPlaying = deck.isPlaying;

                // If the requested song is currently playing on the other deck, pick a different next song
                const otherDeck = deck.id === 'a' ? deckB : deckA;
                if (otherDeck.song && song.id === otherDeck.song.id && otherDeck.isPlaying) {
                    const avoidIds = new Set([deck.song ? deck.song.id : -1, otherDeck.song.id]);
                    const alt = getNextPlayableSong(song.id, avoidIds);
                    if (alt) song = alt; else return; // nothing suitable
                }

                if (deck.song) { 
                     handleDeckStop(deck);
                }

                deck.song = song; 
                deck.audio.src = song.url;
                deck.ui.title.textContent = song.title;
                deck.ui.artist.textContent = song.artist;
                checkAndApplyMarquee(deck.ui.title);
                renderPlaylist();

                if (shouldAutoplay || otherDeck.isPlaying || wasPlaying) {
                    setTimeout(() => {
                        handleDeckPlayPause(deck);
                    }, 150); 
                }
            }
            
            async function cacheSong(url) {
                try {
                    const cacheName = 'dj-songs-cache';
                    const cache = await caches.open(cacheName);
                    const isCached = await cache.match(url);
                    if (!isCached) {
                        console.log(`Caching: ${url}`);
                        await cache.add(url);
                    }
                    cachedServerUrls.add(url);
                    renderPlaylist();
                } catch (error) {
                    console.error(`Failed to cache ${url}:`, error);
                }
            }

            async function checkIfUrlCached(url) {
                try {
                    const cache = await caches.open('dj-songs-cache');
                    const match = await cache.match(url);
                    if (match) {
                        cachedServerUrls.add(url);
                    }
                } catch {}
            }

            function toggleServerSongs() {
                if(areServerSongsLoaded) {
                    // Hide server songs
                    playlist = playlist.filter(song => song.type !== 'server');
                    areServerSongsLoaded = false;
                    serverSongsBtn.classList.remove('active');
                    serverSongsBtn.title = "Load Server Songs";
                } else {
                    // Load and cache server songs
                    serverSongList.forEach(song => {
                        addSongToPlaylist(song);
                        // Check existing cache and then trigger caching
                        checkIfUrlCached(song.url).then(() => renderPlaylist());
                        cacheSong(song.url);
                    });
                    areServerSongsLoaded = true;
                    serverSongsBtn.classList.add('active');
                    serverSongsBtn.title = "Hide Server Songs";
                }
                renderPlaylist();
            }

            function handleDeckPlayPause(deck) {
                if (!deck.song) return;
                if (audioContext.state === 'suspended') audioContext.resume();
                if (deck.isPlaying) deck.audio.pause(); else deck.audio.play();
                deck.isPlaying = !deck.isPlaying;
                updateDeckPlayPauseButton(deck);
                renderPlaylist();
            }

            function handleDeckStop(deck) {
                if (!deck.song) return;
                deck.audio.pause(); deck.audio.currentTime = 0;
                deck.isPlaying = false;
                updateDeckPlayPauseButton(deck);
                renderPlaylist();
            }
            
            function handleSongEnd(endedDeck) {
                endedDeck.isPlaying = false;
                updateDeckPlayPauseButton(endedDeck);
                renderPlaylist();
                if (!isAutoDjEnabled || !endedDeck.song) return;
                const avoidIds = new Set([
                    endedDeck.song.id,
                    (endedDeck.id === 'a' ? deckB : deckA).song ? (endedDeck.id === 'a' ? deckB : deckA).song.id : -1
                ]);
                const nextSong = getNextPlayableSong(endedDeck.song.id, avoidIds);
                if (!nextSong) return;
                loadSongToDeck(endedDeck, nextSong.id, true);
            }

            // Find next song in playlist after given songId that is not in avoidIds
            function getNextPlayableSong(fromSongId, avoidIds = new Set()) {
                if (playlist.length === 0) return null;
                let startIndex = playlist.findIndex(s => s.id === fromSongId);
                if (startIndex === -1) startIndex = -1; // start from beginning
                for (let i = 1; i <= playlist.length; i++) {
                    const idx = (startIndex + i) % playlist.length;
                    const candidate = playlist[idx];
                    if (!avoidIds.has(candidate.id)) return candidate;
                }
                return null;
            }

            function updateDeckPlayPauseButton(deck) {
                const icon = deck.ui.playPauseBtn.querySelector('i');
                deck.ui.playPauseBtn.classList.toggle('playing', deck.isPlaying);
                if (deck.isPlaying) icon.classList.replace('fa-play', 'fa-pause');
                else icon.classList.replace('fa-pause', 'fa-play');
            }
            
            function updateCrossfader() {
                const value = parseInt(crossfader.value, 10); 
                const a_gain = Math.cos((value + 100) / 200 * 0.5 * Math.PI);
                const b_gain = Math.cos((100 - value) / 200 * 0.5 * Math.PI);
                deckA.nodes.crossfadeGain.gain.setValueAtTime(a_gain, audioContext.currentTime);
                deckB.nodes.crossfadeGain.gain.setValueAtTime(b_gain, audioContext.currentTime);
                deckAUi.container.style.borderColor = value < 0 ? 'var(--deck-a-color)' : 'transparent';
                deckBUi.container.style.borderColor = value > 0 ? 'var(--deck-b-color)' : 'transparent';
            }

            function formatTime(seconds) { const m = Math.floor(seconds / 60); const s = Math.floor(seconds % 60); return `${m}:${s < 10 ? '0' : ''}${s}`; }

            function updateDeckTime(deck) {
                if (isNaN(deck.audio.duration)) return;
                deck.ui.currentTime.textContent = formatTime(deck.audio.currentTime);
                deck.ui.duration.textContent = formatTime(deck.audio.duration);
                deck.ui.seekBar.max = deck.audio.duration;
                if (!isSeeking[deck.id]) deck.ui.seekBar.value = deck.audio.currentTime;
            }
            
            function handleVolumeChange(deck) {
                const value = parseInt(deck.ui.volumeSlider.value, 10) / 100;
                deck.nodes.volumeGain.gain.setValueAtTime(value * value, audioContext.currentTime);
            }

            function handleEqChange(deck, band, value) { const gainValue = value / 100 * 24; deck.nodes[band].gain.setValueAtTime(gainValue, audioContext.currentTime); }
            
            function handleFilterChange(deck, value) {
                const filterNode = deck.nodes.filter;
                const maxFreq = audioContext.sampleRate / 2;
                value = parseInt(value);
                if (value === 0) { filterNode.frequency.setValueAtTime(maxFreq, audioContext.currentTime); return; }
                const noctaves = Math.log2(maxFreq / 40); let freq;
                if (value > 0) { filterNode.type = 'lowpass'; freq = 40 * Math.pow(2, noctaves * (1 - value / 100)); } 
                else { filterNode.type = 'highpass'; freq = 40 * Math.pow(2, noctaves * (Math.abs(value) / 100)); }
                filterNode.frequency.setValueAtTime(freq, audioContext.currentTime);
            }

            function handleSeek(deck) { deck.audio.currentTime = deck.ui.seekBar.value; }

            function showContextMenu(e) {
                e.preventDefault();
                if (isReorderMode) return;
                const songItem = e.target.closest('li');
                if (!songItem) return;
                activeContextMenuSongId = parseInt(songItem.dataset.songId, 10);
                contextMenu.style.display = 'block';
                contextMenu.style.left = `${Math.min(e.clientX, window.innerWidth - contextMenu.offsetWidth - 10)}px`;
                contextMenu.style.top = `${Math.min(e.clientY, window.innerHeight - contextMenu.offsetHeight - 10)}px`;
            }

            function hideContextMenu() { contextMenu.style.display = 'none'; activeContextMenuSongId = null; }

            function setupEventListeners() {
                uploadBtn.addEventListener('click', () => uploadInput.click());
                uploadInput.addEventListener('change', (e) => {
                    [...e.target.files].forEach(file => {
                        const songData = { title: file.name.replace(/\.[^/.]+$/, ""), artist: 'Uploaded', url: URL.createObjectURL(file), type: 'user' };
                        addSongToPlaylist(songData);
                    });
                });
                autoDjBtn.addEventListener('click', () => { isAutoDjEnabled = !isAutoDjEnabled; autoDjBtn.classList.toggle('active', isAutoDjEnabled); });
                playlistUl.addEventListener('click', (e) => { if (e.target.closest('.more-options-btn')) showContextMenu(e); });
                crossfader.addEventListener('input', updateCrossfader);
                serverSongsBtn.addEventListener('click', toggleServerSongs);

                fullscreenPlaylistBtn.addEventListener('click', () => {
                    djApp.classList.toggle('playlist-fullscreen-active');
                    const icon = fullscreenPlaylistBtn.querySelector('i');
                    if (djApp.classList.contains('playlist-fullscreen-active')) {
                        icon.classList.replace('fa-expand', 'fa-compress');
                        fullscreenPlaylistBtn.title = 'Close Playlist';
                    } else {
                        icon.classList.replace('fa-compress', 'fa-expand');
                        fullscreenPlaylistBtn.title = 'Fullscreen Playlist';
                    }
                });
                
                reorderBtn.addEventListener('click', () => {
                    isReorderMode = !isReorderMode;
                    playlistUl.classList.toggle('reorder-mode', isReorderMode);
                    reorderBtn.classList.toggle('active', isReorderMode);
                    const icon = reorderBtn.querySelector('i');
                    if (isReorderMode) {
                        icon.classList.replace('fa-bars-staggered', 'fa-check');
                        reorderBtn.title = 'Done Reordering';
                    } else {
                         icon.classList.replace('fa-check', 'fa-bars-staggered');
                        reorderBtn.title = 'Reorder Playlist';
                    }
                    renderPlaylist(); 
                });

                // Drag and Drop Logic for Playlist
                playlistUl.addEventListener('dragstart', (e) => {
                    setTimeout(() => e.target.classList.add('dragging'), 0);
                });
                playlistUl.addEventListener('dragend', (e) => {
                    e.target.classList.remove('dragging');
                });
                playlistUl.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(playlistUl, e.clientY);
                    const currentDragged = document.querySelector('.dragging');
                    if (afterElement == null) {
                        playlistUl.appendChild(currentDragged);
                    } else {
                        playlistUl.insertBefore(currentDragged, afterElement);
                    }
                });
                playlistUl.addEventListener('drop', (e) => {
                    const newPlaylistOrder = [...playlistUl.querySelectorAll('li')].map(li => {
                        const songId = parseInt(li.dataset.songId);
                        return playlist.find(song => song.id === songId);
                    });
                    playlist = newPlaylistOrder;
                });

                function getDragAfterElement(container, y) {
                    const draggableElements = [...container.querySelectorAll('li:not(.dragging)')];
                    return draggableElements.reduce((closest, child) => {
                        const box = child.getBoundingClientRect();
                        const offset = y - box.top - box.height / 2;
                        if (offset < 0 && offset > closest.offset) {
                            return { offset: offset, element: child };
                        } else {
                            return closest;
                        }
                    }, { offset: Number.NEGATIVE_INFINITY }).element;
                }

                // Deck A Listeners
                deckAUi.playPauseBtn.addEventListener('click', () => handleDeckPlayPause(deckA));
                deckAUi.stopBtn.addEventListener('click', () => handleDeckStop(deckA));
                deckAUi.cueBtn.addEventListener('click', () => { if(deckA.audio) deckA.audio.currentTime = 0; });
                deckAUi.seekBar.addEventListener('input', () => handleSeek(deckA));
                deckAUi.seekBar.addEventListener('mousedown', () => isSeeking.a = true);
                deckAUi.seekBar.addEventListener('mouseup', () => isSeeking.a = false);
                deckAUi.volumeSlider.addEventListener('input', () => handleVolumeChange(deckA));
                deckAUi.eq.high.addEventListener('input', (e) => handleEqChange(deckA, 'eqHigh', e.target.value));
                deckAUi.eq.mid.addEventListener('input', (e) => handleEqChange(deckA, 'eqMid', e.target.value));
                deckAUi.eq.low.addEventListener('input', (e) => handleEqChange(deckA, 'eqLow', e.target.value));
                deckAUi.eq.filter.addEventListener('input', (e) => handleFilterChange(deckA, e.target.value));

                // Deck B Listeners
                deckBUi.playPauseBtn.addEventListener('click', () => handleDeckPlayPause(deckB));
                deckBUi.stopBtn.addEventListener('click', () => handleDeckStop(deckB));
                deckBUi.cueBtn.addEventListener('click', () => { if(deckB.audio) deckB.audio.currentTime = 0; });
                deckBUi.seekBar.addEventListener('input', () => handleSeek(deckB));
                deckBUi.seekBar.addEventListener('mousedown', () => isSeeking.b = true);
                deckBUi.seekBar.addEventListener('mouseup', () => isSeeking.b = false);
                deckBUi.volumeSlider.addEventListener('input', () => handleVolumeChange(deckB));
                deckBUi.eq.high.addEventListener('input', (e) => handleEqChange(deckB, 'eqHigh', e.target.value));
                deckBUi.eq.mid.addEventListener('input', (e) => handleEqChange(deckB, 'eqMid', e.target.value));
                deckBUi.eq.low.addEventListener('input', (e) => handleEqChange(deckB, 'eqLow', e.target.value));
                deckBUi.eq.filter.addEventListener('input', (e) => handleFilterChange(deckB, e.target.value));

                document.getElementById('load-to-deck-a').addEventListener('click', () => {
                    if(activeContextMenuSongId !== null) loadSongToDeck(deckA, activeContextMenuSongId);
                    hideContextMenu();
                });
                document.getElementById('load-to-deck-b').addEventListener('click', () => {
                    if(activeContextMenuSongId !== null) loadSongToDeck(deckB, activeContextMenuSongId);
                    hideContextMenu();
                });
                document.getElementById('remove-from-list').addEventListener('click', () => {
                    console.log('Remove button clicked, activeContextMenuSongId:', activeContextMenuSongId);
                    if(activeContextMenuSongId !== null) {
                        const songToRemove = playlist.find(s => s.id === activeContextMenuSongId);
                        console.log('Song to remove:', songToRemove);
                        if (songToRemove) {
                            confirmationMessage.textContent = `Are you sure you want to remove "${songToRemove.title}" from the playlist?`;
                            confirmationDialog.style.display = 'flex';
                            console.log('Confirmation dialog should be visible now');
                            // Don't hide context menu here - let the confirmation dialog handle it
                        }
                    } else {
                        hideContextMenu(); // Only hide if no song is selected
                    }
                });

                // Confirmation dialog button handlers (moved outside to avoid multiple listeners)
                confirmationCancelBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Cancel button clicked');
                    confirmationDialog.style.display = 'none';
                    hideContextMenu(); // Hide context menu when canceling
                });

                confirmationConfirmBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Confirm button clicked, activeContextMenuSongId:', activeContextMenuSongId);
                    if (activeContextMenuSongId !== null) {
                        console.log('Removing song with ID:', activeContextMenuSongId);
                        playlist = playlist.filter(s => s.id !== activeContextMenuSongId);
                        console.log('Playlist after removal:', playlist.length, 'songs');
                        renderPlaylist();
                        confirmationDialog.style.display = 'none';
                        hideContextMenu(); // Hide context menu after confirming
                        activeContextMenuSongId = null;
                    } else {
                        console.log('No active song ID to remove');
                        confirmationDialog.style.display = 'none';
                        hideContextMenu();
                    }
                });

                // Close dialog when clicking overlay
                confirmationDialog.addEventListener('click', (e) => {
                    if (e.target === confirmationDialog) {
                        console.log('Overlay clicked, closing dialog');
                        confirmationDialog.style.display = 'none';
                        hideContextMenu(); // Hide context menu when clicking overlay
                    }
                });

                window.addEventListener('click', (e) => {
                    if (!contextMenu.contains(e.target) && !e.target.closest('.more-options-btn')) {
                        hideContextMenu();
                    }
                });
            }

            init();
        });
    </script>
</body>
</html>

